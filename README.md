# **Гречневый вопрос. Детекция с помощью CV. Real-time сканер гречки.**
Привет!
Существует проблема, связанная с гречкой. Перед готовкой её надо очистить от стороннего мусора. Это можно сделать так: залить водой и убрать всплывший мусор. Но данный метод убирает далеко не весь сор. Ручная же сортировка крупы довольно кропотливый процесс. Поэтому вполне логично попытаться его упростить через небольшую автоматизацию, а именно воспользоваться компьютерным зрением для обнаружения мусора.
В качестве модели компьютерного зрения была выбрана модель YOLO8n от ultralytics (подробности смотри в ноутбуке [GrechnikNet/GrechnikNet_notebook.ipynb at main · Paradise151/GrechnikNet](https://github.com/Paradise151/GrechnikNet/blob/main/GrechnikNet_notebook.ipynb)). Дообучив модель на собственном датасете, были получены следующие результаты: полнота (recall) = 0.682 - процент найденных примесей среди всех имеющихся примесей и точность (precision) = 0.89 - доля реальных примесей среди всех объектов, выявленных нейросетью как примеси.
Пример обнаружения мусора в гречке можно увидеть  на картинки ниже.
![ER диаграмма базы данных рецептов](https://github.com/Paradise151/GrechnikNet/blob/main/photo_video/%D0%A4%D0%BE%D1%82%D0%BE1.png)
# **Real-time детекция. MVP.**
Помимо самой модели интерес представляет реализация работы нейронки в режиме реального времени. Были испробованы разные решения (совсем не без помощи LLM): Hugging Face (Docker + FastApi), Gradio и приложение TensorFlow Lite. Первые две попытки оказались вполне успешными, за исключением задержки серверов и следующего из этого зависания выходного видео потока. Поэтому в первом варианте выходной поток был заменен на возможность сделать фото видимой через камеру области. Пример работы решения Hugging Face (Docker + FastApi) смотри ниже.  
![Гифка работы демки](https://github.com/Paradise151/GrechnikNet/blob/main/photo_video/optimized_demo.gif)

Таким образом были решены две задачи - детекция примесей в гречке с помощью компьютерного зрения и создание MVP (минимального жизнеспособного продукта) - сканера гречки.
Подводя итог, можно выделить несколько оставшихся моментов, которые потенциально могут улучшить решения двух вышеописанных задач.
# **Что можно ещё сделать?**
1) Получить большой recall в ущерб точности. Цена ошибки - комфорт пользователя. В одном кадре детекции (лично мне) комфортно видеть 1-2 истинных значения и 6-7 ложных, в общем минимальная точность может быть около 0.23.
2) Можно из одного класса примесей сделать два (или даже больше)
Как после этого изменится recall? (Отметим, что важно общее количество найденных объектов-примесей, а не верная принадлежность к конкретному классу). 
3) Оставить только черные штуки и посмотреть на изменения. 
4) Куда это всё внедрять и где использовать?  
a) В быту.  
b) В общепите.   
c) В рамках честного знака.  
d) (мне больше всего это нравится) В приложениях продуктовых сетей для углубления взаимодействия покупателя с приложением (т.е. не только ради карты лояльности магазина). А там уже и изучение функционала, предложений, доставки и восприятие бренда как технологического.  
e) Приложения/ сервисы от самих производителей круп (QR код на упаковке), некоторое конкурентное преимущество.  
5) Применить решения с доступными лицензиями.
6) Воспользоваться другими моделями, в т.ч. одноэтапными.
7) Обучить все слои, а не 12 первых модулей или наоборот обучить меньше модулей.
8) Дообучить модель, обученную на пшеничном датасете Global Wheat Head Dataset. 
9) Если взять ту же YOLO и на torch её заново собрать послойно и немного изменить активации и тд. перестанет ли на это распространяться авторское право? 
10) Попытаться сделать приложение-детектор гречки, в т.ч. на основе приложения tensorflow lite через модификацию вывода выбранной модели в файле-детекторе tensorflow_lite_support/cc/task/vision/object_detector.cc.
11) Создать соревнование на Kaggle. Посоревноваться и решить задачу детекции гречки, да и просто разрешить эту проблему (довольно милую и важную).

# **Небольшая инструкция**
Рекомендую посмотреть демку и воспользоваться её при готовке!
1) Если демка на Hugging Face спит из-за неактивности, то нажмите Restart this Space и ждите.
2) Нажмите Старт.
3) Выберите камеру (вначале включится фронтальная камера, не бойтесь и выберите заднюю камеру).
4) Можете выбрать подходящую степень уверенности conf и метрику iou.
5) Наведите камеру на гречку и нажмите Сделать фото.
6) Подождите и появится фото с детекцией. Далее проделывайте так (5,6 пункты) с другими областями гречки.

# **Ссылки:**
1) Демка нейронки на Hugging Face:  
https://huggingface.co/spaces/Paradise151/GrechnikNet 
2) Ноутбук с кодом на GitHub:  
https://github.com/Paradise151/GrechnikNet/blob/main/GrechnikNet_notebook.ipynb
3) Датасет на Hugging Face:  
https://huggingface.co/datasets/Paradise151/GrechnikDataset 
